# TUI Testing Framework

A 4-level testing framework for the Tark TUI.

## Quick Start

```bash
# Unit tests - Individual widgets (~1s)
cargo test --test tui_widget_tests

# UI Snapshots - Visual regression (~2s)
cargo test --test tui_snapshot_tests
cargo insta review  # Review snapshot changes

# Integration - Component interactions (~10s)
cargo test --test cucumber_tui_new

# E2E - Real binary in PTY (~30s)
cargo test --test cucumber_e2e --release
```

## Test Levels

| Level | Tool | Purpose | Speed |
|-------|------|---------|-------|
| **Unit** | `#[test]` | Test individual widgets/functions | <1s |
| **UI Snapshots** | `insta` | Fast visual regression testing | ~2s |
| **Integration** | Cucumber + TestBackend | Test component interactions | ~10s |
| **E2E** | Cucumber + PTY | Test real binary in real terminal | ~30s |

## Directory Structure

```
tests/
├── tui_test_driver/          # Shared test utilities
│   ├── mod.rs                # Main driver
│   ├── keys.rs               # Key parsing: "Ctrl+B" → KeyEvent
│   ├── buffer.rs             # Buffer reading utilities
│   └── pty.rs                # PTY wrapper for E2E
│
├── tui_widget_tests.rs       # Level 1: Widget unit tests
├── tui_snapshot_tests.rs     # Level 2: UI snapshot tests (insta)
├── cucumber_tui_new.rs       # Level 3: Integration tests
├── cucumber_e2e.rs           # Level 4: E2E tests (PTY)
│
├── snapshots/                # Auto-generated by insta
│   └── *.snap
│
└── visual/tui/features/      # Gherkin feature files
    └── 00_smoke_test_e2e.feature
```

## When to Use What

| Question | Test Level | Command |
|----------|------------|---------|
| Does this widget render correctly? | Unit | `cargo test --test tui_widget_tests` |
| Did I break the layout? | Snapshot | `cargo test --test tui_snapshot_tests` |
| Does pressing X cause Y? | Integration | `cargo test --test cucumber_tui_new` |
| Does the real binary work? | E2E | `cargo test --test cucumber_e2e --release` |

## Example: Widget Unit Test

```rust
// tests/tui_widget_tests.rs
#[test]
fn test_status_bar_shows_mode() {
    let theme = Theme::default();
    let widget = StatusBar::new(&theme)
        .agent_mode(AgentMode::Build);
    
    let output = render_widget(widget, 120, 1);
    assert!(output.contains("Build"));
}
```

## Example: UI Snapshot Test

```rust
// tests/tui_snapshot_tests.rs
#[test]
fn snapshot_help_modal() {
    let mut app = create_test_app(100, 30);
    assert_snapshot!("initial_layout", capture_buffer(&mut app));
}

// Review changes
// $ cargo insta review
```

## Example: Integration Test

```gherkin
# tests/visual/tui/features/*.feature
Scenario: Toggle sidebar
  Given the TUI is running
  When I press "Ctrl+B"
  Then the sidebar should be hidden
```

## Example: E2E Test

```gherkin
# tests/visual/tui/features/00_smoke_test_e2e.feature
@e2e
Scenario: Application starts successfully
  Given the TUI application is running
  Then I should see "Welcome"
```

## Test Driver Utilities

The `tui_test_driver` module provides shared utilities:

### Key Parsing

```rust
use tui_test_driver::keys;

// Parse to KeyEvent
let event = keys::parse("Ctrl+B")?;

// Convert to terminal bytes (for PTY)
let bytes = keys::to_terminal_bytes("Ctrl+B")?;
```

### Buffer Reading

```rust
use tui_test_driver::buffer;

// Convert buffer to string
let text = buffer::to_string(buf, width, height);

// Get a specific line
let line = buffer::line(buf, y, width);

// Check if buffer contains text
let has_it = buffer::contains(buf, "Welcome", width, height);
```

### PTY Driver (E2E)

```rust
use tui_test_driver::pty::PtyDriver;

// Spawn real binary
let mut pty = PtyDriver::spawn("./target/release/tark", &["tui"], 120, 40)?;

// Send keys
pty.send_key("Ctrl+B")?;

// Wait for text
pty.wait_for("Welcome", 5000)?;

// Read screen
let screen = pty.read_screen()?;
```

## Workflow

### Daily Development

```bash
# 1. Make changes
# 2. Run fast tests
cargo test --test tui_widget_tests
cargo test --test tui_snapshot_tests

# 3. Review any snapshot changes
cargo insta review

# 4. Commit
git add tests/snapshots/
git commit -m "feat: add new modal"
```

### Before PR

```bash
# Run full test suite
cargo test --test tui_widget_tests
cargo test --test tui_snapshot_tests
cargo test --test cucumber_tui_new
cargo test --test cucumber_e2e --release
```

### CI Pipeline

1. **Unit tests** - Widget tests (~1s)
2. **Snapshot tests** - UI regression (~2s)
3. **Snapshot verification** - Ensure no uncommitted changes
4. **Integration tests** - Cucumber (~10s)
5. **E2E tests** (on main branch) - Real binary (~30s)

## Dependencies

```toml
[dev-dependencies]
insta = { version = "1.40", features = ["filters"] }
portable-pty = "0.8"
cucumber = "0.21"
```

## See Also

- [Plan](../root/.cursor/plans/tui_testing_framework_*.plan.md)
- [AGENTS.md](../AGENTS.md) - Testing guidelines
- [tests/visual/README.md](visual/README.md) - Visual E2E tests with asciinema
